WITH PROCESSING_TIME AS(
SELECT
    MACHINE_ID,
    PROCESS_ID,
    CASE
        WHEN ACTIVITY_TYPE = 'start' THEN TIMESTAMP
        ELSE 0
        END AS START_TMESTAMP,
    CASE WHEN ACTIVITY_TYPE = 'end' THEN TIMESTAMP
        ELSE 0
        END AS END_TMESTAMP
FROM
    ACTIVITY),TOTAL_PROCESSING_TIME AS(
SELECT MACHINE_ID,
        PROCESS_ID,
        SUM(END_TMESTAMP)-SUM(START_TMESTAMP) as TOTAL_TIME
FROM PROCESSING_TIME
GROUP BY MACHINE_ID,PROCESS_ID)

SELECT
    MACHINE_ID,
    ROUND(SUM(TOTAL_TIME)/COUNT(TOTAL_TIME),3) as PROCESSING_TIME
FROM
    TOTAL_PROCESSING_TIME
GROUP BY MACHINE_ID;

